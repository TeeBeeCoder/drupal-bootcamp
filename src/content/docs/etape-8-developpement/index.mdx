---
title: Ã‰tape 8 - DÃ©veloppement Custom
description: CrÃ©er le module de panier e-commerce avec htmx et paiement Stripe pour TailStore
sidebar:
  order: 0

# status: stable
# last-reviewed: 2026-01-14
---

import { Card, CardGrid, Aside } from '@astrojs/starlight/components';

<div class="duration-badge">â±ï¸ DurÃ©e estimÃ©e : 6h</div>

## ğŸ¯ Objectifs de cette Ã©tape

Ã€ la fin de cette Ã©tape, vous serez capable de :

- âœ… **CrÃ©er un module Drupal custom** professionnel et maintenable
- âœ… **DÃ©finir des routes et controllers** selon les standards Drupal
- âœ… **MaÃ®triser l'injection de dÃ©pendances** et le container Symfony
- âœ… **CrÃ©er des services mÃ©tier** rÃ©utilisables et testables
- âœ… **IntÃ©grer htmx** pour des interactions dynamiques sans JavaScript complexe
- âœ… **ImplÃ©menter Stripe Checkout** en mode sÃ©curisÃ©
- âœ… **Appliquer les bonnes pratiques** de dÃ©veloppement Drupal moderne

<Aside type="note" title="Contexte e-commerce">
Cette Ã©tape est le **cÅ“ur technique** de TailStore. Nous allons dÃ©velopper le module `tailstore_cart` qui gÃ¨re :
- ğŸ›’ **Panier persistant** : Stockage en session avec support multi-utilisateurs
- âš¡ **Interactions temps rÃ©el** : Ajout/suppression via htmx (AJAX sans JavaScript)
- ğŸ’³ **Paiement sÃ©curisÃ©** : IntÃ©gration Stripe Checkout en mode redirect
- ğŸ“§ **Notifications** : Emails de confirmation de commande

Ce module peut Ãªtre rÃ©utilisÃ© et adaptÃ© pour d'autres projets e-commerce Drupal.
</Aside>

## ğŸ“‹ PrÃ©requis

### Connaissances requises

- [x] **Ã‰tapes 1-7 terminÃ©es** : Structure Drupal, contenus, thÃ¨me
- [x] **PHP orientÃ© objet** : Classes, interfaces, namespaces
- [x] **PSR-4 autoloading** : Organisation des classes
- [x] **Notions de design patterns** : Dependency Injection, Service Container
- [x] **HTTP/REST** : MÃ©thodes GET, POST, PATCH, DELETE

<Aside type="caution" title="Niveau technique">
Cette Ã©tape nÃ©cessite des **bases solides en PHP**. Si vous dÃ©butez en POO :
1. RÃ©visez les concepts : classes, interfaces, namespaces
2. Lisez la doc Symfony sur le [Dependency Injection](https://symfony.com/doc/current/service_container.html)
3. Familiarisez-vous avec [PSR-4](https://www.php-fig.org/psr/psr-4/)

Le dÃ©veloppement de modules est plus complexe que la configuration.
</Aside>

### Outils nÃ©cessaires

- [x] **Compte Stripe** : [CrÃ©er un compte test gratuit](https://dashboard.stripe.com/register)
- [x] **Ã‰diteur avec autocomplÃ©tion** : PHPStorm, VS Code + PHP Intelephense
- [x] **Xdebug** (recommandÃ©) : Pour debugger le code PHP

```bash
# VÃ©rifier Xdebug
ddev exec php -v | grep Xdebug

# Activer si nÃ©cessaire
ddev config --xdebug-enabled
ddev restart
```

## ğŸ“š Sommaire

<CardGrid stagger>
  <Card title="1. Structure d'un module" icon="setting">
    Architecture et fichiers de base d'un module custom.
    [Voir â†’](/etape-8-developpement/structure-module/)
  </Card>
  <Card title="2. Routes & Controllers" icon="rocket">
    CrÃ©er des pages personnalisÃ©es avec routing Drupal.
    [Voir â†’](/etape-8-developpement/routes-controllers/)
  </Card>
  <Card title="3. Services & DI" icon="puzzle">
    Injection de dÃ©pendances et services mÃ©tier.
    [Voir â†’](/etape-8-developpement/services/)
  </Card>
  <Card title="4. Form API" icon="pencil">
    CrÃ©er des formulaires programmatiques sÃ©curisÃ©s.
    [Voir â†’](/etape-8-developpement/form-api/)
  </Card>
  <Card title="5. htmx & AJAX" icon="seti:javascript">
    Interactions dynamiques sans JavaScript complexe.
    [Voir â†’](/etape-8-developpement/htmx/)
  </Card>
  <Card title="6. Stripe Checkout" icon="approve-check">
    Paiement sÃ©curisÃ© avec l'API Stripe.
    [Voir â†’](/etape-8-developpement/stripe/)
  </Card>
  <Card title="TD 1 : Panier & Services" icon="open-book">
    Atelier pratique - Module Cart et injections.
    [Faire le TD â†’](/etape-8-developpement/td-blocs-programmatiques-1/)
  </Card>
  <Card title="TD 2 : Config & Search" icon="search">
    Atelier pratique - Store Info et Search personnalisÃ©s.
    [Faire le TD â†’](/etape-8-developpement/td-blocs-programmatiques-2/)
  </Card>
</CardGrid>

## ğŸ—ï¸ Architecture du module TailStore Cart

Nous allons crÃ©er le module `tailstore_cart` qui gÃ¨re :

- Le panier cÃ´tÃ© serveur
- L'API pour htmx
- Le checkout Stripe

### Structure complÃ¨te

```
modules/custom/tailstore_cart/
â”œâ”€â”€ tailstore_cart.info.yml          # DÃ©claration du module
â”œâ”€â”€ tailstore_cart.module            # Hooks et fonctions
â”œâ”€â”€ tailstore_cart.services.yml      # DÃ©claration des services
â”œâ”€â”€ tailstore_cart.routing.yml       # Routes
â”œâ”€â”€ tailstore_cart.permissions.yml   # Permissions
â”œâ”€â”€ tailstore_cart.libraries.yml     # Assets
â”‚
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ Controller/
â”‚   â”‚   â”œâ”€â”€ CartController.php       # API panier (htmx)
â”‚   â”‚   â””â”€â”€ CheckoutController.php   # Stripe checkout
â”‚   â”‚
â”‚   â”œâ”€â”€ Service/
â”‚   â”‚   â”œâ”€â”€ CartService.php          # Logique panier
â”‚   â”‚   â””â”€â”€ StripeService.php        # API Stripe
â”‚   â”‚
â”‚   â”œâ”€â”€ Form/
â”‚   â”‚   â”œâ”€â”€ CartForm.php             # Formulaire panier
â”‚   â”‚   â””â”€â”€ CheckoutForm.php         # Formulaire checkout
â”‚   â”‚
â”‚   â”œâ”€â”€ EventSubscriber/
â”‚   â”‚   â””â”€â”€ CartEventSubscriber.php  # Events
â”‚   â”‚
â”‚   â””â”€â”€ Plugin/
â”‚       â””â”€â”€ Block/
â”‚           â””â”€â”€ MiniCartBlock.php    # Bloc mini-panier
â”‚
â”œâ”€â”€ templates/
â”‚   â”œâ”€â”€ cart-page.html.twig
â”‚   â”œâ”€â”€ cart-item.html.twig
â”‚   â””â”€â”€ mini-cart.html.twig
â”‚
â””â”€â”€ config/
    â””â”€â”€ install/
        â””â”€â”€ tailstore_cart.settings.yml
```

## ğŸ§© Concepts Drupal Ã  maÃ®triser

### PSR-4 Autoloading

Drupal utilise le standard **PSR-4** pour le chargement automatique des classes :

```
Namespace: Drupal\tailstore_cart\Controller\CartController
Fichier:   modules/custom/tailstore_cart/src/Controller/CartController.php
```

**RÃ¨gles de nommage** :
- Namespace racine : `Drupal\[nom_module]`
- Dossier `src/` : Point d'entrÃ©e du namespace
- Sous-dossiers : AjoutÃ©s au namespace
- Nom de fichier : Identique au nom de la classe

<Aside type="tip" title="Bonne pratique">
**Organisation par type** :
- `Controller/` : Logique de prÃ©sentation et rÃ©ponses HTTP
- `Service/` : Logique mÃ©tier rÃ©utilisable
- `Form/` : Formulaires Drupal Form API
- `Plugin/` : Plugins (blocs, champs, actions...)
- `EventSubscriber/` : Ã‰couteurs d'Ã©vÃ©nements

Cette organisation facilite la navigation et la maintenance.
</Aside>

### Injection de dÃ©pendances

Pattern **central** dans Drupal moderne (depuis Drupal 8) :

```php
class CartController extends ControllerBase {
  
  /**
   * Constructor avec dÃ©pendances injectÃ©es.
   *
   * @param CartService $cartService
   *   Service de gestion du panier.
   * @param EntityTypeManagerInterface $entityTypeManager
   *   Gestionnaire d'entitÃ©s pour charger les produits.
   */
  public function __construct(
    private readonly CartService $cartService,
    private readonly EntityTypeManagerInterface $entityTypeManager,
  ) {}
  
  /**
   * {@inheritdoc}
   *
   * MÃ©thode statique appelÃ©e par le container.
   */
  public static function create(ContainerInterface $container): static {
    return new static(
      $container->get('tailstore_cart.cart'),
      $container->get('entity_type.manager'),
    );
  }
}
```

**Avantages** :
- âœ… **TestabilitÃ©** : Facile de mocker les dÃ©pendances
- âœ… **FlexibilitÃ©** : Changement d'implÃ©mentation sans toucher au controller
- âœ… **ClartÃ©** : DÃ©pendances explicites
- âœ… **RÃ©utilisabilitÃ©** : Services partagÃ©s entre modules

<Aside type="caution" title="âš ï¸ Ã€ Ã©viter">
**NE PAS utiliser** `\Drupal::service()` dans les controllers/services :

```php
// âŒ Mauvais (couplage fort, difficile Ã  tester)
public function myMethod() {
  $cart = \Drupal::service('tailstore_cart.cart');
}

// âœ… Bon (injection de dÃ©pendances)
public function __construct(
  private readonly CartService $cartService,
) {}
```

Exceptions acceptÃ©es : `.module`, hooks, procÃ©duraux.
</Aside>

### Container de services

Drupal utilise le **Service Container** de Symfony :

```yaml
# tailstore_cart.services.yml
services:
  # DÃ©claration du service
  tailstore_cart.cart:
    class: Drupal\tailstore_cart\Service\CartService
    arguments: 
      - '@request_stack'          # Service injectÃ©
      - '@entity_type.manager'    # Service injectÃ©
    
  # Alias avec interface (recommandÃ©)
  Drupal\tailstore_cart\Service\CartServiceInterface: '@tailstore_cart.cart'
```

**Conventions de nommage** :
- Format : `[module].[nom_service]`
- Exemples : `tailstore_cart.cart`, `tailstore_cart.stripe`
- Services core : Point au dÃ©but (ex: `.entity_type.manager`)

## ğŸ”Œ Technologies intÃ©grÃ©es

### htmx

**htmx** permet d'ajouter des comportements AJAX directement dans le HTML :

```html
<button 
  hx-post="/cart/add/42"
  hx-target="#cart-count"
  hx-swap="innerHTML"
>
  Ajouter au panier
</button>
```

<Aside type="tip" title="htmx vs JavaScript">
htmx rÃ©duit considÃ©rablement le code JavaScript nÃ©cessaire pour les interactions serveur.
</Aside>

### Stripe Checkout

Mode **Redirect** simplifiÃ© :

1. L'utilisateur clique sur "Commander"
2. Drupal crÃ©e une session Stripe
3. Redirection vers la page Stripe hosted
4. Stripe gÃ¨re le paiement
5. Retour sur le site avec confirmation

```php
$session = \Stripe\Checkout\Session::create([
  'payment_method_types' => ['card'],
  'line_items' => $items,
  'mode' => 'payment',
  'success_url' => $successUrl,
  'cancel_url' => $cancelUrl,
]);

return new RedirectResponse($session->url);
```

## ğŸ”„ Flux du panier TailStore

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        Frontend                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                               â”‚
â”‚  [Produit]  â”€â”€htmx POSTâ”€â”€>  [Mini-Cart]  â”€â”€>  [Page Panier]  â”‚
â”‚                   â”‚               â”‚                â”‚          â”‚
â”‚                   â–¼               â–¼                â–¼          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                       Controller                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   CartController::add()                                       â”‚
â”‚   CartController::update()                                    â”‚
â”‚   CartController::remove()                                    â”‚
â”‚   CheckoutController::create()                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                        Services                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   CartService           StripeService                         â”‚
â”‚   â”œâ”€â”€ add()             â”œâ”€â”€ createSession()                  â”‚
â”‚   â”œâ”€â”€ remove()          â”œâ”€â”€ handleWebhook()                  â”‚
â”‚   â”œâ”€â”€ getItems()        â””â”€â”€ getSession()                     â”‚
â”‚   â””â”€â”€ getTotal()                                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                       Stockage                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   Session PHP / Table custom                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ“‹ FonctionnalitÃ©s Ã  dÃ©velopper

| FonctionnalitÃ© | Route | MÃ©thode |
|----------------|-------|---------|
| Ajouter au panier | `/cart/add/{product_id}` | POST |
| Modifier quantitÃ© | `/cart/update/{product_id}` | PATCH |
| Supprimer | `/cart/remove/{product_id}` | DELETE |
| Voir le panier | `/cart` | GET |
| Mini-panier (htmx) | `/cart/mini` | GET |
| CrÃ©er checkout | `/checkout/create` | POST |
| SuccÃ¨s paiement | `/checkout/success` | GET |
| Annulation | `/checkout/cancel` | GET |
| Webhook Stripe | `/webhook/stripe` | POST |

## ğŸ” SÃ©curitÃ©

### Protection CSRF

Drupal gÃ¨re automatiquement les tokens CSRF pour les **formulaires Form API**.

Pour les requÃªtes AJAX/htmx, ajoutez la validation :

```php
// Dans le controller
use Symfony\Component\HttpFoundation\Request;
use Symfony\Component\HttpKernel\Exception\AccessDeniedHttpException;

public function add(int $product_id, Request $request): Response {
  // VÃ©rifier le token CSRF
  $token = $request->headers->get('X-CSRF-Token');
  if (!\Drupal::csrfToken()->validate($token, 'cart_action')) {
    throw new AccessDeniedHttpException('Invalid CSRF token');
  }
  
  // Traitement...
}
```

```html
<!-- Dans le template -->
<button 
  hx-post="/cart/add/42"
  hx-headers='{"X-CSRF-Token": "{{ csrf_token('cart_action') }}"}'>
  Ajouter
</button>
```

### Validation des donnÃ©es

**Toujours valider** les entrÃ©es utilisateur :

```php
public function add(int $product_id, Request $request): Response {
  // Validation du product_id
  $product = $this->entityTypeManager
    ->getStorage('node')
    ->load($product_id);
  
  if (!$product || $product->bundle() !== 'product') {
    throw new NotFoundHttpException('Product not found');
  }
  
  // Validation de la quantitÃ©
  $quantity = (int) $request->request->get('quantity', 1);
  if ($quantity < 1 || $quantity > 99) {
    throw new BadRequestHttpException('Invalid quantity');
  }
  
  // Traitement sÃ©curisÃ©...
}
```

### Permissions

DÃ©finissez des **permissions granulaires** :

```yaml
# tailstore_cart.permissions.yml
access cart:
  title: 'Access shopping cart'
  description: 'View and manage own shopping cart'
  
access checkout:
  title: 'Access checkout'
  description: 'Proceed to payment and place orders'
  
administer tailstore cart:
  title: 'Administer TailStore Cart'
  description: 'Configure cart settings and view all carts'
  restrict access: true
```

Utilisez dans les routes :

```yaml
tailstore_cart.cart:
  path: '/cart'
  defaults:
    _controller: '\Drupal\tailstore_cart\Controller\CartController::index'
  requirements:
    _permission: 'access cart'
```

<Aside type="caution" title="SÃ©curitÃ© Stripe">
**ClÃ©s API** :
- âŒ **Jamais** committer les clÃ©s dans Git
- âœ… Utiliser des variables d'environnement
- âœ… ClÃ©s diffÃ©rentes dev/prod
- âœ… Mode test par dÃ©faut en dev

**Webhook** :
- âœ… Valider la signature Stripe
- âœ… Log tous les webhooks
- âœ… Gestion d'erreurs robuste

Voir section [Stripe Checkout](/etape-8-developpement/stripe/) pour dÃ©tails.
</Aside>

## ğŸ§ª Tests

### PHPUnit

```php
namespace Drupal\Tests\tailstore_cart\Unit;

use Drupal\Tests\UnitTestCase;

class CartServiceTest extends UnitTestCase {
  
  public function testAddItem(): void {
    // Test logic
  }
}
```

### ExÃ©cution

```bash
ddev exec ./vendor/bin/phpunit modules/custom/tailstore_cart/tests
```

## ğŸš€ C'est parti !

Commencez par [Structure d'un module](/etape-8-developpement/structure-module/).
